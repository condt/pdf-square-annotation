(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();class X{isPending;promise;resolver;rejecter;constructor(){this.isPending=!0,this.promise=new Promise((e,t)=>{this.resolver=e,this.rejecter=t})}async wait(){return await this.promise}success(e){this.isPending=!1,this.resolver(e)}fail(e){this.isPending=!1,this.rejecter(e)}}class F{openState=new X;constructor(){}async open(e){const t=document.createElement("iframe");if(t.id="pdfjs",t.width="100%",t.height="100%",t.style.border="none",typeof e=="string")t.src=e;else{const r=URL.createObjectURL(e);t.src=`../pdfjs/web/viewer.html?file=${r}`}return document.getElementById("pdfjs-container").appendChild(t),await this.openState.wait()}successOpen(){this.openState.success()}}const Z={squareAnnotation:{SquareStyle:{backgroundColor:"rgba(0,255,0,0.3)",border:null},handlerStyle:{backgroundColor:"rgba(0,0,200,1)"}}};class V{config=Z;constructor(){}setConfig(e){this.mergeConfig(e)}mergeConfig(e){e.squareAnnotation??={},e.squareAnnotation.SquareStyle??={},e.squareAnnotation.SquareStyle.backgroundColor??=this.config.squareAnnotation.SquareStyle.backgroundColor,e.squareAnnotation.SquareStyle.border??=this.config.squareAnnotation.SquareStyle.border,e.squareAnnotation.handlerStyle??={},e.squareAnnotation.handlerStyle.backgroundColor??=this.config.squareAnnotation.handlerStyle.backgroundColor,this.config=e}}class a{static window;static document;static PDFViewerApplication;static pdfjs;static pdfjsLib;static pagesCount;static debug=null;static pdfManager=null;static squareAnnotation=null;static app;static params;static config;static isDebug(){if(a.debug==null)if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")a.debug=!0;else{if(a.params==null)throw"params is null.";a.debug=a.params.debug}return a.debug}}const W=s=>{if(typeof s!="string")return!1;let e=null,t=null;return s.split(";").forEach(r=>{const o=r.trim().replace(" ","");o.startsWith("color:")?e=o.split("color:")[1]:o.startsWith("background-color:")&&(t=o.split("background-color:")[1])}),e!=null||t!=null},G=(...s)=>{if(a.isDebug()){if(s.length>1&&W(s[s.length-1])){const t=s.map((n,r)=>r===s.length-1?n:"%c"+n);console.trace(...t);return}console.trace(...s)}},J=(...s)=>{console.log(...s)},Q=(...s)=>{console.warn(...s)},K=(...s)=>{console.error(...s)},l={debug:G,info:J,warn:Q,error:K};class ee{constructor(){}async getPagesAsync(){const e=[];for(let t=1;t<=a.pagesCount;t++){const n=await this.getPageAsync(t);n!=null&&e.push(n)}return e}async getPageAsync(e){return await a.pdfjs.getPage(e)}getPages(){const e=[];for(let t=1;t<=a.pagesCount;t++){const n=a.document.querySelector(`div.page[data-page-number="${t}"]`);if(n==null){l.error(`page element not found: ${t}`);continue}e.push(n)}return e}getPage(e){return a.document.querySelector(`div.page[data-page-number="${e}"]`)}getPageElement(e){return e.parentElement.parentElement}getPageNumber(e){const t=this.getPageElement(e),n=parseInt(t.getAttribute("data-page-number"));if(isNaN(n))throw`[getPageNumber()] invalid annotation: ${e}`;return n}getAnnotationLayer(e){const t=typeof e=="number"?this.getPage(e):e;if(t==null)throw`page ${e} not found.`;const n=t.querySelector(".annotationLayer");return n??(l.debug(`annotation layer ${e} not found.`),null)}getTextLayer(e){const t=typeof e=="number"?this.getPage(e):e;if(t==null)throw`page ${e} not found.`;const n=t.querySelector(".textLayer");return n??(l.debug(`text layer ${e} not found.`),null)}}const te=s=>JSON.parse(JSON.stringify(s)),ne=(s,e,t)=>{const n=typeof s=="string"?s:JSON.stringify(s),r=new Blob([n],{type:t}),o=URL.createObjectURL(r),i=document.createElement("a");i.href=o,i.download=e,i.click(),URL.revokeObjectURL(o)},se=async(s="*")=>new Promise((e,t)=>{const n=document.createElement("input");n.setAttribute("type","file"),n.setAttribute("accept",s),n.click(),n.onchange=async r=>{const o=r.target.files;if(o.length===0){t("cancel");return}const d=await o[0].text();e(d)},n.oncancel=()=>{t("cancel")}}),q={deepCopy:te,download:ne,selectFile:se},A=10,B="rgba(0,255,0,0.3)",z="10px",c="-3px",I="#097CC8",H={CAN_CREATE:"crosshair",MOVABLE:"move"},re=["square-annotation"];class ae{_state="ready";selectSquareId=null;draggingResizeHandlerId=null;resizeStartSquareWidth=null;resizeStartSquareHeight=null;resizeStartSquareX=0;resizeStartSquareY=0;draggingMoveSquareId=null;createStartX=0;createStartY=0;creatingSquareElement=null;moveStartX=0;moveStartY=0;constructor(){}cancelCreate(){l.debug("cancel create.","color: #555; background-color: yellow"),this.creatingSquareElement.remove(),this.selectSquareId==null?this.setReadyState():this.setSelectState()}cancelResize(){if(this.isResizing()){const e=a.document.getElementById(this.selectSquareId);e!=null&&(e.style.width=this.resizeStartSquareWidth,e.style.height=this.resizeStartSquareHeight),this.setSelectState(null)}}initParams(){this.draggingResizeHandlerId=null,this.createStartX=0,this.createStartY=0,this.creatingSquareElement=null,this.moveStartX=0,this.moveStartY=0,this.draggingMoveSquareId=null}setReadyState(){this.initParams(),this.selectSquareId=null,this._state="ready"}get state(){return this._state}setSelectState(e){if(e==null){if(this.selectSquareId==null)throw"selectSquareId is null: 矩形選択状態で実行してください";return this.initParams(),this._state="select-square",!0}return this.state==="select-square"&&this.selectSquareId===e?!1:(this.initParams(),this.selectSquareId=e,this._state="select-square",!0)}setCreateState(e,t,n){l.debug("start create"),e.style.width="0px",e.style.height="0px",e.style.left=`${t}px`,e.style.top=`${n}px`,e.style.pointerEvents="none",e.style.backgroundColor=B,this.initParams(),this.createStartX=t,this.createStartY=n,this.creatingSquareElement=e,this._state="create-dragging"}setResizeReadyState(e,t,n,r,o){this.initParams(),this.draggingResizeHandlerId=e,this.resizeStartSquareWidth=t,this.resizeStartSquareHeight=n,this.resizeStartSquareX=r,this.resizeStartSquareY=o,this._state="resize-ready"}setMoveReadyState(e,t,n){l.debug("start move."),this.initParams(),this.draggingMoveSquareId=e,this.moveStartX=t,this.moveStartY=n,this._state="move-ready"}createDragging(e,t){const n=e-this.createStartX,r=t-this.createStartY;n<=5||r<=5||(this.creatingSquareElement.style.width=`${n}px`,this.creatingSquareElement.style.height=`${r}px`)}resizeDragging(e,t){const n=a.document.getElementById(this.selectSquareId);let r=0,o=0;this.draggingResizeHandlerId==="square-handler-bottom-right"?(r=e-this.resizeStartSquareX,o=t-this.resizeStartSquareY):this.draggingResizeHandlerId==="square-handler-top-left"?(r=this.resizeStartSquareX-e,o=this.resizeStartSquareY-t):this.draggingResizeHandlerId==="square-handler-top-right"?(r=e-this.resizeStartSquareX,o=this.resizeStartSquareY-t):this.draggingResizeHandlerId==="square-handler-bottom-left"&&(r=this.resizeStartSquareX-e,o=t-this.resizeStartSquareY),!(r<A||o<A)&&(n.style.width=`${r}px`,n.style.height=`${o}px`,this._state="resize-dragging")}moveDragging(e,t){const n=a.document.getElementById(this.draggingMoveSquareId);n.style.left=`${e-this.moveStartX}px`,n.style.top=`${t-this.moveStartY}px`,this._state="move-dragging"}getSelectingSquare(){const e=a.document.getElementById(this.selectSquareId);if(e==null)throw`select square not found, id=${this.selectSquareId}`;return e}isSelect(e){return this.state==="select-square"&&this.selectSquareId===e}isResizing(){return this.state==="resize-dragging"||this.state==="resize-ready"}isMoving(){return this.state==="move-dragging"||this.state==="move-ready"}canCreate(){return this.state==="ready"||this.state==="select-square"}}const D=s=>{document.querySelectorAll(".mode-button").forEach(e=>{e.classList.remove("selected")}),s==="edit"?document.getElementById("edit-square-button").classList.add("selected"):s==="preview"&&document.getElementById("preview-button").classList.add("selected")};class ${static stackId=1;editStateManager;stackIndex=-1;mode="preview";initialSquares=[];currentSquares=[];undoStack=[];constructor(){this.editStateManager=new ae}toggleMode(){this.mode==="edit"?this.setPreviewMode():this.mode==="preview"&&this.setEditMode()}setEditMode(){if(this.mode==="edit")return;const e=this.mode;try{this.mode="edit",this.editStateManager.setReadyState(),this.renderAllPages(),this.setSquareDoubleClick()}catch(t){this.mode=e,l.error(t),l.error("restore mode: ",e)}D(this.mode)}setPreviewMode(){if(this.mode==="preview")return;const e=this.mode;try{this.mode="preview",this.editStateManager.setReadyState(),this.renderAllPages(),this.setSquareDoubleClick(),this.removeResizeHandler(),this.removeDeleteIcon()}catch(t){this.mode=e,l.error(t),l.error("restore mode: ",e)}D(this.mode)}renderAllPages(){a.pdfManager.getPages().forEach(e=>{l.debug(`==render page: ${e.getAttribute("data-page-number")}==`),this.renderAnnotationLayer(a.pdfManager.getAnnotationLayer(e)),this.renderTextLayer(a.pdfManager.getTextLayer(e))}),this.currentSquares.forEach(e=>this.renderSquare(e))}onRenderEvent(e,t){const n=a.pdfManager.getPage(e),r=a.pdfManager.getAnnotationLayer(n),o=a.pdfManager.getTextLayer(n);if(r==null){l.debug(`P${e} annotation layer is null`,"color: yellow");return}if(o==null){l.debug(`P${e} text layer is null`,"color: yellow");return}const i=this.getSquares(e),d=r.querySelectorAll(".square-annotation");i.length>0&&d.length===0&&(l.debug("描画します: ",e),i.forEach(u=>{this.createSquareSection(u.id,r,u.props)})),this.renderPageSquares(e),this.renderAnnotationLayer(r),this.renderTextLayer(o)}renderPageSquares(e){this.getSquares(e).forEach(t=>this.renderSquare(t))}renderSquare(e){const t=a.document.getElementById(e.id);if(t==null){l.debug(`square element not found: ${e.id}`);return}this.setSquareEvent(t)}renderAnnotationLayer(e){if(e==null){l.debug("annotation layer not found");return}e.style.display="flex !important",e.style.width="100%",e.style.height="100%",e.removeAttribute("hidden"),this.setAnnotationLayerPropagation(e),this.mode==="edit"?(e.style.cursor=H.CAN_CREATE,e.style.pointerEvents="auto",this.enableEditSquare(e)):(e.style.cursor=null,e.style.pointerEvents="none",e.onmousedown=null,e.onmousemove=null,e.onmouseup=null,e.onmouseleave=null)}renderTextLayer(e){if(e==null){l.debug("text layer not found");return}this.mode==="edit"?e.style.pointerEvents="none":e.style.pointerEvents="auto"}getSquares(e){return this.currentSquares.filter(t=>t.pageNumber===e)}}const oe=s=>{if(s==null){l.warn("set percent style square is null.");return}const{width:e,height:t,x:n,y:r}=s.getBoundingClientRect(),o=s.parentElement,{width:i,height:d,x:u,y:g}=o.getBoundingClientRect(),f=e/i,m=t/d,M=n-u,R=r-g,v=M/i,E=R/d;return s.style.width=`${f*100}%`,s.style.height=`${m*100}%`,s.style.left=`${v*100}%`,s.style.top=`${E*100}%`,s.style.right=null,s.style.bottom=null,{xScale:v,yScale:E,widthScale:f,heightScale:m}},k=()=>Array.from(a.document.querySelectorAll(".square-annotation")).filter(e=>e!=null),C=s=>{k().forEach(e=>{e.style.pointerEvents=s})};class T{constructor(e=0){this._value=e}next(){return this._value++,this._value}set value(e){this._value=e}}class ie extends T{nextId(){return`square-annotation-${this.next()}`}updateNextId(e){const t=Math.max(...e)+1;b.squareId.value=t}updateNextId2(e){let t=0;e.forEach(n=>{const r=n.split("-"),o=r[r.length-1],i=parseInt(o);if(isNaN(i)){l.error(`updateNextId: ${n} is invalid.`);return}i>t&&(t=i)}),b.squareId.value=t}}class le extends T{nextIndex(){const e=this.next();return String(e)}}const b={squareId:new ie(0),squareZindex:new le(1e5)},de=s=>{const e=s.editStateManager;return t=>{if(l.debug("layer mousedown"),C("none"),e.canCreate()){const n=t.target,r=b.squareId.nextId(),o=s.createSquareSection(r,n);e.setCreateState(o,t.offsetX,t.offsetY)}}},ue=s=>{const e=s.editStateManager;return t=>{e.state==="create-dragging"?e.createDragging(t.offsetX,t.offsetY):e.isResizing()?e.resizeDragging(t.offsetX,t.offsetY):e.isMoving()&&e.moveDragging(t.offsetX,t.offsetY)}},ce=s=>{const e=s.editStateManager;return t=>{l.debug("layer mouseup"),C("auto"),e.state==="create-dragging"?(l.debug("finish create dragging: ",t),O(s)):e.isResizing()?he(s):e.isMoving()&&_(s)}},ge=s=>{const e=s.editStateManager;return t=>{l.debug("layer mouseleave"),C("auto"),e.state==="create-dragging"?(l.debug("finish create dragging: ",t),O(s)):e.isResizing()?e.cancelResize():e.isMoving()&&_(s)}},O=s=>{const e=s.editStateManager,{width:t,height:n,x:r,y:o}=e.creatingSquareElement.getBoundingClientRect();return t<A||n<A?(e.cancelCreate(),!1):(l.debug("complete create"),s.addUndoStack(e.creatingSquareElement,"create"),s.selectSquare(e.creatingSquareElement.id),!0)},he=s=>{const e=s.editStateManager;l.debug("complete resize"),e.state==="resize-dragging"&&s.addUndoStack(e.getSelectingSquare(),"modify"),e.setSelectState(null)},_=s=>{const e=s.editStateManager;l.debug("complete move"),e.state==="move-dragging"&&s.addUndoStack(e.getSelectingSquare(),"modify"),e.setSelectState(null)},x={mouseDown:de,mouseMove:ue,mouseUp:ce,mouseLeave:ge},pe=(s,e,t,n)=>{const r=s.editStateManager;return l.debug("edit handler mousedown"),o=>{const i=r.getSelectingSquare(),d=i.parentElement,{x:u,y:g,width:f,height:m,right:M,bottom:R}=i.getBoundingClientRect(),{x:v,y:E,width:j,height:Y}=d.getBoundingClientRect(),h=u-v,p=g-E,P=j-h-f,L=Y-p-m;let S=0,y=0;e==="square-handler-bottom-right"?(l.debug("右下"),i.style.left=`${h}px`,i.style.top=`${p}px`,i.style.right=null,i.style.bottom=null,S=h,y=p):e==="square-handler-top-left"?(l.debug("左上"),i.style.left=null,i.style.top=null,i.style.right=`${P}px`,i.style.bottom=`${L}px`,S=h+f,y=p+m):e==="square-handler-top-right"?(l.debug("右上"),i.style.left=`${h}px`,i.style.top=null,i.style.right=null,i.style.bottom=`${L}px`,S=h,y=p+m):e==="square-handler-bottom-left"&&(l.debug("左下"),i.style.left=null,i.style.top=`${p}px`,i.style.right=`${P}px`,i.style.bottom=null,S=h+f,y=p),r.setResizeReadyState(e,t,n,S,y)}},fe={mouseDown:pe},me=(s,e)=>{const t=s.editStateManager;return n=>{l.debug("square mousedown"),t.canCreate()&&(t.isSelect(e)||s.selectSquare(e),t.setMoveReadyState(e,n.offsetX,n.offsetY))}},Se=()=>s=>{s.stopPropagation(),l.debug("square click")},N={mouseDown:me,click:Se},ye=["border","backgroundColor"],qe=s=>{const e={};for(const t of ye)e[t]=s.style[t];return e},we='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>',U="square-annotation-",be=(s,e)=>{s.forEach(t=>{if(t.pageNumber<1||e<t.pageNumber)throw"無効なアノテーション情報です"})},ve=s=>Ee(s.squares),Ee=s=>s.map(e=>({...e,id:Me(e.id)})),Ie=s=>({squares:xe(s)}),xe=s=>s.map(e=>({id:Ce(e.id),pageNumber:e.pageNumber,props:Ae(e.props)})),Ae=s=>({x:s?.x??0,y:s?.y??0,width:s?.width??0,height:s?.height??0,style:ke(s?.style)}),ke=s=>({backgroundColor:s?.backgroundColor??B,border:s?.border??null}),Ce=s=>{const e=parseInt(s.replace(U,""));if(isNaN(e))throw`getId: ${s} is invalid.`;return e},Me=s=>`${U}${s}`;class w extends ${enableEditSquare(e){e.onmousedown=x.mouseDown(this),e.onmousemove=x.mouseMove(this),e.onmouseup=x.mouseUp(this),e.onmouseleave=x.mouseLeave(this)}removeResizeHandler(){const e=t=>{t?.remove()};e(a.document.getElementById(this.getSquareHandlerId("top-left"))),e(a.document.getElementById(this.getSquareHandlerId("top-right"))),e(a.document.getElementById(this.getSquareHandlerId("bottom-left"))),e(a.document.getElementById(this.getSquareHandlerId("bottom-right")))}removeDeleteIcon(){const e=a.document.getElementById("square-delete-icon");e?.remove()}drawResizeHandler(e){l.debug("draw resize handler",e);const t=a.document.getElementById(e);this.removeResizeHandler(),this.createDragHandlerElement(t,"top-left"),this.createDragHandlerElement(t,"top-right"),this.createDragHandlerElement(t,"bottom-left"),this.createDragHandlerElement(t,"bottom-right"),this.removeDeleteIcon(),this.createDeleteIcon(t)}createDragHandlerElement(e,t){const n=a.document.createElement("div"),r=this.getSquareHandlerId(t);return n.id=r,n.style.position="absolute",n.style.zIndex="10000000",n.style.width=z,n.style.height=z,t==="top-left"?(n.style.backgroundColor=I,n.style.left=c,n.style.top=c,n.style.cursor="nw-resize"):t==="bottom-left"?(n.style.backgroundColor=I,n.style.left=c,n.style.bottom=c,n.style.cursor="sw-resize"):t==="top-right"?(n.style.backgroundColor=I,n.style.right=c,n.style.top=c,n.style.cursor="ne-resize"):t==="bottom-right"&&(n.style.backgroundColor=I,n.style.right=c,n.style.bottom=c,n.style.cursor="se-resize"),n.onmousedown=fe.mouseDown(this,r,e.style.width,e.style.height),e.appendChild(n),n}createDeleteIcon(e){const t=a.document.createElement("div");t.id="square-delete-icon",t.style.cursor="pointer",t.style.position="absolute",t.style.zIndex="10000000",t.style.right="-30px",t.style.top="0px",t.style.width="20px",t.style.height="24px",t.style.backgroundColor="#000",t.title="矩形を削除します",t.onclick=r=>{r.stopPropagation(),this.deleteSquare(e.id)},t.onmousedown=r=>{r.stopPropagation()};const n=a.document.createElement("svg");n.innerHTML=we,t.appendChild(n),e.appendChild(t)}getSquareHandlerId(e){return`square-handler-${e}`}deleteSquare(e){const t=a.document.getElementById(e);if(t==null){l.error(`delete annotation not found: ${e}`);return}this.addUndoStack(t,"delete"),this.editStateManager.isSelect(e)&&this.editStateManager.setReadyState(),t.remove(),this.removeResizeHandler(),this.removeDeleteIcon()}setSquareDoubleClick(){this.mode==="edit"?a.window.ondblclick=null:this.mode==="preview"&&(a.window.ondblclick=e=>{const t=e.pageX,n=e.pageY;for(const r of k()){const{x:o,y:i,width:d,height:u}=r.getBoundingClientRect();if(t>=o&&t<=o+d&&n>=i&&n<=i+u&&(e.stopPropagation(),l.debug(`${r.id}を選択しました`,r),this.editStateManager.setSelectState(r.id))){this.setEditMode(),this.drawResizeHandler(r.id);return}}})}addUndoStack(e,t){const n=a.pdfManager.getPageNumber(e);if(t==="create"||t==="modify"){const{xScale:r,yScale:o,widthScale:i,heightScale:d}=oe(e),u=qe(e),g={id:e.id,pageNumber:n,props:{x:r,y:o,width:i,height:d,style:u}};this.stackIndex<this.undoStack.length-1&&this.undoStack.splice(this.stackIndex+1),this.updateCurrentSquares(t,q.deepCopy(g)),this.undoStack.push({stackId:w.stackId,squares:[{operation:t,...g}]})}else t==="delete"&&(this.stackIndex<this.undoStack.length-1&&this.undoStack.splice(this.stackIndex+1),this.deleteCurrentSquare(e.id),this.undoStack.push({stackId:w.stackId,squares:[{operation:"delete",pageNumber:n,id:e.id}]}));w.stackId++,this.stackIndex++}updateCurrentSquares(e,t){if(e==="create")this.currentSquares.push(t);else if(e==="modify"){const n=this.currentSquares.find(r=>r.id===t.id);if(n==null){l.error(`modify current squares error: ${t.id}`);return}n.props=t.props}}deleteCurrentSquare(e){const t=this.currentSquares.findIndex(n=>n.id===e);if(t<0){l.error(`delete current squares error: ${e}`);return}this.currentSquares.splice(t,1)}undo(){if(this.stackIndex<0){l.info("undo stack is empty.");return}const e=this.undoStack[this.stackIndex];for(const t of e.squares)if(t.operation==="create")this.refreshTargetSquare(t.id,t.props,"delete","undo"),this.deleteCurrentSquare(t.id);else{const n=this.getLatestUndo(t.id);if(n==null){l.error("latestSquare is null: ",t.id);continue}if(t.operation==="modify")this.refreshTargetSquare(a.document.getElementById(t.id),n.props,"modify","undo"),this.updateCurrentSquares("modify",this.copySquareData(n));else if(t.operation==="delete"){const r=a.pdfManager.getAnnotationLayer(n.pageNumber);this.createSquareSection(n.id,r,n.props);const o=this.copySquareData(n);this.updateCurrentSquares("create",o)}}this.stackIndex--}getLatestUndo(e){if(this.stackIndex===0)return this.getSquareDataFromFirst(e);for(let t=this.stackIndex-1;t>=0;t--){const r=this.undoStack[t].squares.find(o=>o.id===e);if(r!=null)return this.copySquareData(r)}return this.getSquareDataFromFirst(e)}getSquareDataFromFirst(e){for(const t of this.initialSquares)if(t.id===e)return t;return null}refreshTargetSquare(e,t,n,r){if(typeof e=="string"&&(n==="delete"&&this.editStateManager.isSelect(e)&&this.editStateManager.setReadyState(),e=a.document.getElementById(e)),e==null){l.debug(`refreshTargetSquare: ${r} target element is null.`,"color: yellow");return}if(n==="delete"){e.remove();return}if(n==="modify"){l.debug(t),e.style.left=`${t.x*100}%`,e.style.top=`${t.y*100}%`,e.style.width=`${t.width*100}%`,e.style.height=`${t.height*100}%`;for(const[o,i]of Object.entries(t.style))l.debug(o,i),e.style[o]=i}}redo(){if(this.undoStack.length-1===this.stackIndex){l.info("undo stack is latest.");return}const e=this.undoStack[this.stackIndex+1];l.debug("nextStack: ",e);for(const t of e.squares)if(t.operation==="create"){const n=a.pdfManager.getAnnotationLayer(t.pageNumber),r=this.createSquareSection(t.id,n,t.props);this.updateCurrentSquares("create",this.copySquareData(t)),l.debug("create section: ",r)}else t.operation==="modify"?this.refreshTargetSquare(a.document.getElementById(t.id),t.props,"modify","redo"):t.operation==="delete"&&this.refreshTargetSquare(t.id,t.props,"delete","redo");this.stackIndex++}copySquareData(e){const t=q.deepCopy(e);return Object.hasOwn(t,"operation")&&delete t.operation,t}createSquareSection(e,t,n){if(a.document.getElementById(e)!=null){l.warn(`${e}の矩形は存在します`);return}if(t==null){l.debug("annotationLayer is null.","color: yellow");return}const r=a.document.createElement("section");if(r.id=e,r.classList.add("square-annotation"),r.style.position="absolute",r.style.zIndex=b.squareZindex.nextIndex(),n!=null){r.style.left=`${n.x*100}%`,r.style.top=`${n.y*100}%`,r.style.right=null,r.style.bottom=null,r.style.width=`${n.width*100}%`,r.style.height=`${n.height*100}%`;for(const[o,i]of Object.entries(n.style))l.debug(o,i),r.style[o]=i}return this.setSquareEvent(r),t.appendChild(r),this.editStateManager.isSelect(e)&&this.drawResizeHandler(e),r}selectSquare(e){this.editStateManager.setSelectState(e)&&this.drawResizeHandler(e)}setSquareEvent(e){this.mode==="edit"?(e.style.cursor=H.MOVABLE,e.style.pointerEvents=null,e.onmousedown=N.mouseDown(this,e.id),e.onclick=N.click()):(e.style.cursor=null,e.style.pointerEvents="none",e.onmousedown=null,e.onclick=null)}setAnnotationLayerPropagation(e){for(const t of e.children)Array.from(t.classList).some(r=>re.includes(r))||(this.mode==="edit"?t.style.pointerEvents="none":t.style.pointerEvents="auto")}getAnnotations(){return Ie(this.currentSquares)}setAnnotations(e){const t=ve(e);be(t,a.pagesCount),k().forEach(n=>n.remove()),this.undoStack=[],this.stackIndex=-1,$.stackId=1,b.squareId.updateNextId(e.squares.map(n=>n.id)),this.initialSquares=t,this.currentSquares=q.deepCopy(t),this.editStateManager.setReadyState();for(let n=1;n<=a.pagesCount;n++)this.onRenderEvent(n);this.setSquareDoubleClick()}downloadData(){q.download(this.getAnnotations(),"annotations.json","application/json")}async importData(){const e=await q.selectFile(".json");this.setAnnotations(JSON.parse(e))}}class Re{params=null;constructor(e){const n=(e??window.location.href).replace(window.location.origin+window.location.pathname,"");this.params=new URLSearchParams(n)}get(e,t=null){const n=this.params.get(e);return n??t}}class Pe{debug=!1;constructor(){const e=new Re;this.debug=!!e.get("debug")}}a.params=new Pe;a.config=new V;a.app=new F;window.openPdf=async s=>await a.app.open(s);window.setAppConfig=s=>{a.config.setConfig(s)};window.startEdit=()=>{a.squareAnnotation.setEditMode()};window.startPreview=()=>{a.squareAnnotation.setPreviewMode()};window.undo=()=>{a.squareAnnotation.undo()};window.redo=()=>{a.squareAnnotation.redo()};window.getAnnotations=()=>a.squareAnnotation.getAnnotations();window.setAnnotations=s=>{a.squareAnnotation.setAnnotations(s)};window.exportAnnotations=()=>{a.squareAnnotation.downloadData()};window.importAnnotations=async()=>{await a.squareAnnotation.importData()};window.addEventListener("webviewerloaded",async s=>{const e=s?.detail?.source,t=e.document,n=e.PDFViewerApplication,r=e.pdfjsLib;await n.initializedPromise;const o=await n.pdfLoadingTask.promise;a.app.successOpen(),n.eventBus.on("annotationeditorlayerrendered",async i=>{l.debug(`annotationeditorlayerrendered..... ${i.pageNumber}`,i),a.squareAnnotation.onRenderEvent(i.pageNumber,i.source)}),a.document=t,a.window=e,a.PDFViewerApplication=n,a.pdfjs=o,a.pdfjsLib=r,a.pagesCount=n.pagesCount,a.pdfManager=new ee,a.squareAnnotation=new w});
