(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class G{isPending;promise;resolver;rejecter;constructor(){this.isPending=!0,this.promise=new Promise((e,t)=>{this.resolver=e,this.rejecter=t})}async wait(){return await this.promise}success(e){this.isPending=!1,this.resolver(e)}fail(e){this.isPending=!1,this.rejecter(e)}}class K{openState=new G;constructor(){}async open(e){const t=document.createElement("iframe");if(t.id="pdfjs",t.width="100%",t.height="100%",t.style.border="none",typeof e=="string")t.src=e;else{const s=URL.createObjectURL(e);t.src=`../pdfjs/web/viewer.html?file=${s}`}return document.getElementById("pdfjs-container").appendChild(t),await this.openState.wait()}successOpen(){this.openState.success()}}const $=r=>{document.querySelectorAll(".mode-button").forEach(e=>{e.classList.remove("selected")}),r==="edit"?document.getElementById("edit-square-button").classList.add("selected"):r==="preview"&&document.getElementById("preview-button").classList.add("selected")},j=(r,e)=>{r!=null&&T(document.querySelector(".undo-button"),r),e!=null&&T(document.querySelector(".redo-button"),e)},T=(r,e)=>{e?(r.classList.remove("disable"),r.querySelector("svg").style.fill="rgb(227, 227, 227)"):(r.classList.add("disable"),r.querySelector("svg").style.fill="rgb(170, 170, 170)")},J=r=>{for(const[e,t]of Object.entries(r)){if(e==="exportButton"){const n=document.querySelector(".export-button");n.style.display=t?"flex":"none"}if(e==="importButton"){const n=document.querySelector(".import-button");n.style.display=t?"flex":"none"}}},Y="square-annotation-",x=10,ee="rgba(0,255,0,0.3)",te="rgba(150,150,150,0.3)",ne="1px solid rgb(0,0,255)",re="#097CC8",se="",oe="10px",ae="-5px",M={CAN_CREATE:"crosshair",MOVABLE:"move"},ie=["square-annotation"];class o{static window;static document;static PDFViewerApplication;static pdfjs;static pdfjsLib;static pagesCount;static debug=null;static pdfManager=null;static squareAnnotation=null;static app;static params;static config;static isDebug(){if(o.debug==null)if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")o.debug=!0;else{if(o.params==null)throw"params is null.";o.debug=o.params.debug}return o.debug}}const le={toolbar:{exportButton:!0,importButton:!0},squareAnnotation:{normalStyle:{backgroundColor:ee,border:null},lockedStyle:{backgroundColor:te,border:null},selectedStyle:{border:ne},resizeHandlerStyle:{backgroundColor:re,borderRadius:se,size:oe,position:ae}}};class ue{config=le;constructor(){}getConfig(){return this.config}setConfig(e){this.mergeConfig(e),J({exportButton:this.config.toolbar.exportButton,importButton:this.config.toolbar.importButton}),o.squareAnnotation.setAllSquaresStyle(),o.squareAnnotation.setResizeHandlerStyle()}mergeConfig(e){e.squareAnnotation??={},e.toolbar??={},e.toolbar.exportButton??=this.config.toolbar.exportButton,e.toolbar.importButton??=this.config.toolbar.importButton,e.squareAnnotation.normalStyle??={},e.squareAnnotation.normalStyle.backgroundColor??=this.config.squareAnnotation.normalStyle.backgroundColor,e.squareAnnotation.normalStyle.border??=this.config.squareAnnotation.normalStyle.border,e.squareAnnotation.lockedStyle??={},e.squareAnnotation.lockedStyle.backgroundColor??=this.config.squareAnnotation.lockedStyle.backgroundColor,e.squareAnnotation.lockedStyle.border??=this.config.squareAnnotation.lockedStyle.border,e.squareAnnotation.selectedStyle??={},e.squareAnnotation.selectedStyle.border??=this.config.squareAnnotation.selectedStyle.border,e.squareAnnotation.resizeHandlerStyle??={},e.squareAnnotation.resizeHandlerStyle.backgroundColor??=this.config.squareAnnotation.resizeHandlerStyle.backgroundColor,e.squareAnnotation.resizeHandlerStyle.borderRadius??=this.config.squareAnnotation.resizeHandlerStyle.borderRadius,e.squareAnnotation.resizeHandlerStyle.size??=this.config.squareAnnotation.resizeHandlerStyle.size,e.squareAnnotation.resizeHandlerStyle.position??=this.config.squareAnnotation.resizeHandlerStyle.position,this.config=e}}const ce=r=>{if(typeof r!="string")return!1;let e=null,t=null;return r.split(";").forEach(s=>{const a=s.trim().replace(" ","");a.startsWith("color:")?e=a.split("color:")[1]:a.startsWith("background-color:")&&(t=a.split("background-color:")[1])}),e!=null||t!=null},de=(...r)=>{if(o.isDebug()){if(r.length>1&&ce(r[r.length-1])){const t=r.map((n,s)=>s===r.length-1?n:"%c"+n);console.trace(...t);return}console.trace(...r)}},ge=(...r)=>{console.log(...r)},he=(...r)=>{console.warn(...r)},Se=(...r)=>{console.error(...r)},u={debug:de,info:ge,warn:he,error:Se};class fe{constructor(){}async getPagesAsync(){const e=[];for(let t=1;t<=o.pagesCount;t++){const n=await this.getPageAsync(t);n!=null&&e.push(n)}return e}async getPageAsync(e){return await o.pdfjs.getPage(e)}getPages(){const e=[];for(let t=1;t<=o.pagesCount;t++){const n=o.document.querySelector(`div.page[data-page-number="${t}"]`);if(n==null){u.error(`page element not found: ${t}`);continue}e.push(n)}return e}getPage(e){return o.document.querySelector(`div.page[data-page-number="${e}"]`)}getPageElement(e){return e.parentElement.parentElement}getPageNumber(e){const t=this.getPageElement(e),n=parseInt(t.getAttribute("data-page-number"));if(isNaN(n))throw`[getPageNumber()] invalid annotation: ${e}`;return n}getAnnotationLayer(e){const t=typeof e=="number"?this.getPage(e):e;if(t==null)throw`page ${e} not found.`;const n=t.querySelector(".annotationLayer");return n??(u.debug(`annotation layer ${e} not found.`),null)}getTextLayer(e){const t=typeof e=="number"?this.getPage(e):e;if(t==null)throw`page ${e} not found.`;const n=t.querySelector(".textLayer");return n??(u.debug(`text layer ${e} not found.`),null)}}class S{static lockAnnotationIds=[];static isLocked(e){return S.lockAnnotationIds.some(t=>t===e)}constructor(){}}const pe=(r,e)=>{const t=new CustomEvent(r,{cancelable:!0,bubbles:!0,detail:e});window.parent.dispatchEvent(t)},me=r=>JSON.parse(JSON.stringify(r)),ye=(r,e,t)=>{const n=typeof r=="string"?r:JSON.stringify(r),s=new Blob([n],{type:t}),a=URL.createObjectURL(s),i=document.createElement("a");i.href=a,i.download=e,i.click(),URL.revokeObjectURL(a)},qe=async(r="*")=>new Promise((e,t)=>{const n=document.createElement("input");n.setAttribute("type","file"),n.setAttribute("accept",r),n.click(),n.onchange=async s=>{const a=s.target.files;if(a.length===0){t("cancel");return}const c=await a[0].text();e(c)},n.oncancel=()=>{t("cancel")}}),d={dispatchEvent:pe,deepCopy:me,download:ye,selectFile:qe};class be{_state="ready";allowCreateNew=!0;layerMouseDownPropagation=!1;selectSquareId=null;draggingResizeHandlerId=null;resizeStartSquareWidth=null;resizeStartSquareHeight=null;resizeStartSquareX=0;resizeStartSquareY=0;draggingMoveSquareId=null;createStartX=0;createStartY=0;creatingSquareElement=null;moveStartX=0;moveStartY=0;constructor(){}cancelCreate(){u.debug("cancel create.","color: #555; background-color: yellow"),this.creatingSquareElement.remove(),this.selectSquareId==null?this.setReadyState():this.restoreSelectState()}cancelResize(){if(this.isResizing()){const e=o.document.getElementById(this.selectSquareId);e!=null&&(e.style.width=this.resizeStartSquareWidth,e.style.height=this.resizeStartSquareHeight),this.restoreSelectState()}}initParams(){this.draggingResizeHandlerId=null,this.createStartX=0,this.createStartY=0,this.creatingSquareElement=null,this.moveStartX=0,this.moveStartY=0,this.draggingMoveSquareId=null}setReadyState(){this.initParams(),this.selectSquareId=null,this._state="ready"}get state(){return this._state}restoreSelectState(){if(this.selectSquareId==null)throw"selectSquareId is null: 矩形選択状態で実行してください";this.initParams(),this._state="select-square"}canSelectSquare(e){return!S.isLocked(e)}setSelectState(e){this.initParams(),this.selectSquareId=e,this._state="select-square"}setCreateState(e,t,n){u.debug("start create"),e.style.width="0px",e.style.height="0px",e.style.left=`${t}px`,e.style.top=`${n}px`,e.style.pointerEvents="none",this.initParams(),this.createStartX=t,this.createStartY=n,this.creatingSquareElement=e,this._state="create-dragging"}setResizeReadyState(e,t,n,s,a){this.initParams(),this.draggingResizeHandlerId=e,this.resizeStartSquareWidth=t,this.resizeStartSquareHeight=n,this.resizeStartSquareX=s,this.resizeStartSquareY=a,this._state="resize-ready"}setMoveReadyState(e,t,n){u.debug("start move."),this.initParams(),this.draggingMoveSquareId=e,this.moveStartX=t,this.moveStartY=n,this._state="move-ready"}createDragging(e,t){const n=e-this.createStartX,s=t-this.createStartY;n<=5||s<=5||(this.creatingSquareElement.style.width=`${n}px`,this.creatingSquareElement.style.height=`${s}px`)}resizeDragging(e,t){const n=o.document.getElementById(this.selectSquareId);let s=0,a=0;this.draggingResizeHandlerId==="square-handler-bottom-right"?(s=e-this.resizeStartSquareX,a=t-this.resizeStartSquareY):this.draggingResizeHandlerId==="square-handler-top-left"?(s=this.resizeStartSquareX-e,a=this.resizeStartSquareY-t):this.draggingResizeHandlerId==="square-handler-top-right"?(s=e-this.resizeStartSquareX,a=this.resizeStartSquareY-t):this.draggingResizeHandlerId==="square-handler-bottom-left"&&(s=this.resizeStartSquareX-e,a=t-this.resizeStartSquareY),!(s<x||a<x)&&(n.style.width=`${s}px`,n.style.height=`${a}px`,this._state="resize-dragging")}moveDragging(e,t){const n=o.document.getElementById(this.draggingMoveSquareId);n.style.left=`${e-this.moveStartX}px`,n.style.top=`${t-this.moveStartY}px`,this._state="move-dragging"}getSelectingSquare(){const e=o.document.getElementById(this.selectSquareId);if(e==null)throw`select square not found, id=${this.selectSquareId}`;return e}isSelect(e){return this.state==="select-square"&&this.selectSquareId===e}isResizing(){return this.state==="resize-dragging"||this.state==="resize-ready"}isMoving(){return this.state==="move-dragging"||this.state==="move-ready"}canCreate(){const e=this.state==="ready"||this.state==="select-square",t=this.allowCreateNew;return e&&t}canMove(){return this.state==="ready"||this.state==="select-square"}}class U{static stackId=1;editStateManager;stackIndex=-1;mode="preview";initialSquares=[];currentSquares=[];undoStack=[];constructor(){this.editStateManager=new be}toggleMode(){this.mode==="edit"?this.setPreviewMode():this.mode==="preview"&&this.setEditMode()}setEditMode(){if(this.mode==="edit")return;const e=this.mode;try{this.mode="edit",this.editStateManager.setReadyState(),this.renderAllPages(),this.setSquareDoubleClick()}catch(t){this.mode=e,u.error(t),u.error("restore mode: ",e)}$(this.mode)}setPreviewMode(){if(this.mode==="preview")return;const e=this.mode;try{this.mode="preview",this.unselectSquare(this.editStateManager.selectSquareId),this.renderAllPages(),this.setSquareDoubleClick()}catch(t){this.mode=e,u.error(t),u.error("restore mode: ",e)}$(this.mode)}renderAllPages(){o.pdfManager.getPages().forEach(e=>{u.debug(`==render page: ${e.getAttribute("data-page-number")}==`),this.renderAnnotationLayer(o.pdfManager.getAnnotationLayer(e)),this.renderTextLayer(o.pdfManager.getTextLayer(e))}),this.currentSquares.forEach(e=>this.renderSquare(e))}onRenderEvent(e,t){const n=o.pdfManager.getPage(e),s=o.pdfManager.getAnnotationLayer(n),a=o.pdfManager.getTextLayer(n);if(s==null){u.debug(`P${e} annotation layer is null`,"color: yellow");return}if(a==null){u.debug(`P${e} text layer is null`,"color: yellow");return}const i=this.getSquares(e),c=s.querySelectorAll(".square-annotation");i.length>0&&c.length===0&&(u.debug("描画します: ",e),i.forEach(l=>{const g=this.createSquareSection(l.id,s,l.props);this.editStateManager.isSelect(l.id)&&this.selectSquare(g)})),this.renderPageSquares(e),this.renderAnnotationLayer(s),this.renderTextLayer(a)}renderPageSquares(e){this.getSquares(e).forEach(t=>this.renderSquare(t))}renderSquare(e){const t=o.document.getElementById(e.id);if(t==null){u.debug(`square element not found: ${e.id}`);return}this.setSquareEvent(t)}renderAnnotationLayer(e){if(e==null){u.debug("annotation layer not found");return}e.style.display="flex !important",e.style.width="100%",e.style.height="100%",e.removeAttribute("hidden"),this.setAnnotationLayerPropagation(e),this.mode==="edit"?(e.style.cursor=this.editStateManager.allowCreateNew?M.CAN_CREATE:null,e.style.pointerEvents="auto",this.enableEditSquare(e)):(e.style.cursor=null,e.style.pointerEvents="none",e.onmousedown=null,e.onmousemove=null,e.onmouseup=null,e.onmouseleave=null)}renderTextLayer(e){if(e==null){u.debug("text layer not found");return}this.mode==="edit"?e.style.pointerEvents="none":e.style.pointerEvents="auto"}getSquares(e){return this.currentSquares.filter(t=>t.pageNumber===e)}showCurrentSquares(){u.debug("==currentSquares=="),u.debug(this.currentSquares),u.debug("==undoStack=="),u.debug(this.undoStack)}}const R=r=>{const e=typeof r=="string"?o.document.getElementById(r):r,t=e?.id??"";return{squareElement:e,squareId:t}},I=r=>S.lockAnnotationIds.includes(r)?"locked":"normal",h=r=>{const e=parseInt(r.replace(Y,""));if(isNaN(e))throw`getId: ${r} is invalid.`;return e},C=r=>`${Y}${r}`,we=r=>{if(r==null){u.warn("set percent style square is null.");return}const{width:e,height:t,x:n,y:s}=r.getBoundingClientRect(),a=r.parentElement,{width:i,height:c,x:l,y:g}=a.getBoundingClientRect(),m=e/i,y=t/c,D=n-l,B=s-g,v=D/i,E=B/c;return r.style.width=`${m*100}%`,r.style.height=`${y*100}%`,r.style.left=`${v*100}%`,r.style.top=`${E*100}%`,r.style.right=null,r.style.bottom=null,{xScale:v,yScale:E,widthScale:m,heightScale:y}},P=()=>Array.from(o.document.querySelectorAll(".square-annotation")).filter(e=>e!=null),L=r=>{P().forEach(e=>{e.style.pointerEvents=r})};class X{constructor(e=0){this._value=e}next(){return this._value++,this._value}set value(e){this._value=e}}class ve extends X{nextId(){const e=this.next();return C(e)}updateNextId(e){const t=Math.max(...e)+1;z.squareId.value=t}}class Ee extends X{nextIndex(){const e=this.next();return String(e)}}const z={squareId:new ve(0),squareZindex:new Ee(1e5)},Ae=(r,e)=>{r.forEach(t=>{if(t.pageNumber<1||e<t.pageNumber)throw"無効なアノテーション情報です"})},ke=r=>Ie(r.squares),Ie=r=>(S.lockAnnotationIds=[],r.map(e=>{const t=C(e.id);return e.state==="locked"&&S.lockAnnotationIds.push(t),delete e.state,{...e,id:t}})),xe=r=>({squares:Re(r)}),Re=r=>r.map(e=>({id:h(e.id),state:I(e.id),pageNumber:e.pageNumber,props:Ce(e.props)})),Ce=r=>({x:r?.x??0,y:r?.y??0,width:r?.width??0,height:r?.height??0}),ze=r=>{const e=r.editStateManager;return t=>{if(e.layerMouseDownPropagation){e.layerMouseDownPropagation=!1;return}if(L("none"),e.canCreate()){const n=t.target,s=z.squareId.nextId(),a=r.createSquareSection(s,n);e.setCreateState(a,t.offsetX,t.offsetY)}}},Me=r=>{const e=r.editStateManager;return t=>{e.state==="create-dragging"?e.createDragging(t.offsetX,t.offsetY):e.isResizing()?e.resizeDragging(t.offsetX,t.offsetY):e.isMoving()&&e.moveDragging(t.offsetX,t.offsetY)}},Pe=r=>{const e=r.editStateManager;return t=>{L("auto"),e.state==="create-dragging"?(u.debug("finish create dragging: ",t),F(r)):e.isResizing()?De(r):e.isMoving()&&Z(r)}},Le=r=>{const e=r.editStateManager;return t=>{L("auto"),e.state==="create-dragging"?(u.debug("finish create dragging: ",t),F(r)):e.isResizing()?e.cancelResize():e.isMoving()&&Z(r)}},F=r=>{const e=r.editStateManager,{width:t,height:n,x:s,y:a}=e.creatingSquareElement.getBoundingClientRect();if(t<x||n<x)return e.cancelCreate(),!1;u.debug("complete create");const i=r.addUndoStack(e.creatingSquareElement,"create");return r.selectSquare(e.creatingSquareElement.id),d.dispatchEvent("change-square",{type:"create",trigger:"operation",id:h(i.id),pageNumber:i.pageNumber,props:i.props}),!0},De=r=>{const e=r.editStateManager;u.debug("complete resize"),e.state==="resize-dragging"&&r.addUndoStack(e.getSelectingSquare(),"modify"),e.restoreSelectState()},Z=r=>{const e=r.editStateManager;u.debug("complete move"),e.state==="move-dragging"&&r.addUndoStack(e.getSelectingSquare(),"modify"),e.restoreSelectState()},A={mouseDown:ze,mouseMove:Me,mouseUp:Pe,mouseLeave:Le},Be=(r,e,t,n)=>{const s=r.editStateManager;return a=>{const i=s.getSelectingSquare(),c=i.parentElement,{x:l,y:g,width:m,height:y,right:D,bottom:B}=i.getBoundingClientRect(),{x:v,y:E,width:V,height:Q}=c.getBoundingClientRect(),f=l-v,p=g-E,N=V-f-m,H=Q-p-y;let b=0,w=0;e==="square-handler-bottom-right"?(i.style.left=`${f}px`,i.style.top=`${p}px`,i.style.right=null,i.style.bottom=null,b=f,w=p):e==="square-handler-top-left"?(i.style.left=null,i.style.top=null,i.style.right=`${N}px`,i.style.bottom=`${H}px`,b=f+m,w=p+y):e==="square-handler-top-right"?(i.style.left=`${f}px`,i.style.top=null,i.style.right=null,i.style.bottom=`${H}px`,b=f,w=p+y):e==="square-handler-bottom-left"&&(i.style.left=null,i.style.top=`${p}px`,i.style.right=`${N}px`,i.style.bottom=null,b=f+m,w=p),s.setResizeReadyState(e,t,n,b,w)}},Ne={mouseDown:Be},He=(r,e)=>{const t=r.editStateManager;return n=>{t.canMove()&&(t.canSelectSquare(e)?(r.selectSquare(e),t.setMoveReadyState(e,n.offsetX,n.offsetY),d.dispatchEvent("mousedown-square",{id:h(e),state:"normal"})):t.layerMouseDownPropagation=!0)}},$e=()=>r=>{r.stopPropagation()},_={mouseDown:He,click:$e},Te=["border","backgroundColor"],Ue=(r,e)=>{const t=o.config.getConfig();{if(r==="normal")return{...t.squareAnnotation.normalStyle};if(r==="locked")return{...t.squareAnnotation.lockedStyle}}const n={};for(const s of Te)Object.hasOwn(e,s)?n[s]=e[s]:(r==="normal"&&(n[s]=t.squareAnnotation.normalStyle[s]),r==="locked"&&(n[s]=t.squareAnnotation.lockedStyle[s]));return n},k=(r,e)=>{const{squareElement:t}=R(r);if(t==null)return;const n=Ue(e);W(t,n)},O=r=>{const{squareElement:e}=R(r);if(e==null)return;const t=o.config.getConfig();W(e,t.squareAnnotation.selectedStyle)},W=(r,e)=>{if(r!=null)for(const[t,n]of Object.entries(e))r.style[t]=n},_e='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>';class q extends U{enableEditSquare(e){e.onmousedown=A.mouseDown(this),e.onmousemove=A.mouseMove(this),e.onmouseup=A.mouseUp(this),e.onmouseleave=A.mouseLeave(this)}drawResizeHandler(e){this.removeResizeHandler(),this.createResizeHandlerElement(e,"top-left"),this.createResizeHandlerElement(e,"top-right"),this.createResizeHandlerElement(e,"bottom-left"),this.createResizeHandlerElement(e,"bottom-right")}createResizeHandlerElement(e,t){const n=o.config.getConfig(),s=n.squareAnnotation.resizeHandlerStyle.backgroundColor,a=n.squareAnnotation.resizeHandlerStyle.borderRadius,i=n.squareAnnotation.resizeHandlerStyle.size,c=n.squareAnnotation.resizeHandlerStyle.position,l=o.document.createElement("div"),g=this.getSquareHandlerId(t);return l.id=g,l.style.position="absolute",l.style.zIndex="10000000",l.style.width=i,l.style.height=i,l.style.backgroundColor=s,l.style.borderRadius=a,t==="top-left"?(l.style.left=c,l.style.top=c,l.style.cursor="nw-resize"):t==="bottom-left"?(l.style.left=c,l.style.bottom=c,l.style.cursor="sw-resize"):t==="top-right"?(l.style.right=c,l.style.top=c,l.style.cursor="ne-resize"):t==="bottom-right"&&(l.style.right=c,l.style.bottom=c,l.style.cursor="se-resize"),l.onmousedown=Ne.mouseDown(this,g,e.style.width,e.style.height),e.appendChild(l),l}createDeleteIcon(e){this.removeDeleteIcon();const t=o.document.createElement("div");t.id="square-delete-icon",t.style.cursor="pointer",t.style.position="absolute",t.style.zIndex="10000000",t.style.right="-30px",t.style.top="0px",t.style.width="20px",t.style.height="24px",t.style.backgroundColor="#000",t.title="矩形を削除します",t.onclick=s=>{s.stopPropagation(),this.deleteSquare(e)},t.onmousedown=s=>{s.stopPropagation()};const n=o.document.createElement("svg");n.innerHTML=_e,t.appendChild(n),e.appendChild(t)}getSquareHandlerId(e){return`square-handler-${e}`}deleteSquare(e){const{squareElement:t,squareId:n}=R(e);if(t==null){u.error(`delete annotation not found: ${e}`);return}const s=o.pdfManager.getPageNumber(t);this.addUndoStack(t,"delete"),this.deleteSquareElement(t),this.editStateManager.isSelect(n)&&this.editStateManager.setReadyState(),d.dispatchEvent("change-square",{type:"delete",trigger:"operation",id:h(n),pageNumber:s})}setSquareDoubleClick(){this.mode==="edit"?o.window.ondblclick=null:this.mode==="preview"&&(o.window.ondblclick=e=>{const t=e.pageX,n=e.pageY;for(const s of P()){const{x:a,y:i,width:c,height:l}=s.getBoundingClientRect();if(t>=a&&t<=a+c&&n>=i&&n<=i+l){e.stopPropagation(),u.debug(`${s.id}を選択しました`,s);const g=S.isLocked(s.id);d.dispatchEvent("dblclick-square",{id:h(s.id),state:g?"locked":"normal"});return}}})}clearUndoStack(){this.undoStack=[],this.stackIndex=-1,U.stackId=1,this.refreshUndoRedoButton()}addUndoStack(e,t){const n=o.pdfManager.getPageNumber(e);if(t==="create"||t==="modify"){const{xScale:s,yScale:a,widthScale:i,heightScale:c}=we(e),l={id:e.id,pageNumber:n,props:{x:s,y:a,width:i,height:c}},g=d.deepCopy(l);return this.stackIndex<this.undoStack.length-1&&this.undoStack.splice(this.stackIndex+1),this.updateCurrentSquares(t,l),this.undoStack.push({stackId:q.stackId,squares:[{operation:t,...g}]}),q.stackId++,this.stackIndex++,this.refreshUndoRedoButton(),d.deepCopy(l)}else t==="delete"&&(this.stackIndex<this.undoStack.length-1&&this.undoStack.splice(this.stackIndex+1),this.deleteCurrentSquare(e.id),this.undoStack.push({stackId:q.stackId,squares:[{operation:"delete",pageNumber:n,id:e.id}]}));q.stackId++,this.stackIndex++,this.refreshUndoRedoButton()}updateCurrentSquares(e,t){if(e==="create")this.currentSquares.push(t);else if(e==="modify"){const n=this.currentSquares.find(s=>s.id===t.id);if(n==null){u.error(`modify current squares error: ${t.id}`);return}n.props=t.props}}deleteCurrentSquare(e){const t=this.currentSquares.findIndex(n=>n.id===e);if(t<0){u.error(`delete current squares error: ${e}`);return}this.currentSquares.splice(t,1)}refreshUndoRedoButton(){let e=!1,t=!1;this.undoStack.length>0&&(this.stackIndex>=0&&(e=!0),this.stackIndex<this.undoStack.length-1&&(t=!0)),j(e,t)}undo(){if(this.stackIndex<0){u.info("undo stack is empty.");return}const e=this.undoStack[this.stackIndex];for(const t of e.squares)if(t.operation==="create")this.refreshTargetSquare(t.id,t.props,"delete","undo"),this.deleteCurrentSquare(t.id),d.dispatchEvent("change-square",{type:"delete",trigger:"undo",id:h(t.id),pageNumber:t.pageNumber});else{const n=this.getLatestUndo(t.id);if(n==null){u.error("latestSquare is null: ",t.id);continue}if(t.operation==="modify")this.refreshTargetSquare(o.document.getElementById(t.id),n.props,"modify","undo"),this.updateCurrentSquares("modify",this.copySquareData(n));else if(t.operation==="delete"){const s=o.pdfManager.getAnnotationLayer(n.pageNumber);this.createSquareSection(n.id,s,n.props);const a=this.copySquareData(n);this.updateCurrentSquares("create",a),d.dispatchEvent("change-square",{type:"create",trigger:"undo",id:h(t.id),pageNumber:t.pageNumber,props:a.props})}}this.stackIndex--,this.refreshUndoRedoButton()}getLatestUndo(e){if(this.stackIndex===0)return this.getSquareDataFromFirst(e);for(let t=this.stackIndex-1;t>=0;t--){const s=this.undoStack[t].squares.find(a=>a.id===e);if(s!=null)return this.copySquareData(s)}return this.getSquareDataFromFirst(e)}getSquareDataFromFirst(e){for(const t of this.initialSquares)if(t.id===e)return t;return null}refreshTargetSquare(e,t,n,s){if(typeof e=="string"&&(n==="delete"&&this.editStateManager.isSelect(e)&&this.editStateManager.setReadyState(),e=o.document.getElementById(e)),e==null){u.debug(`refreshTargetSquare: ${s} target element is null.`,"color: yellow");return}if(n==="delete"){e.remove();return}n==="modify"&&(e.style.left=`${t.x*100}%`,e.style.top=`${t.y*100}%`,e.style.width=`${t.width*100}%`,e.style.height=`${t.height*100}%`)}redo(){if(this.undoStack.length-1===this.stackIndex){u.info("undo stack is latest.");return}const e=this.undoStack[this.stackIndex+1];for(const t of e.squares)if(t.operation==="create"){const n=o.pdfManager.getAnnotationLayer(t.pageNumber),s=this.createSquareSection(t.id,n,t.props);this.updateCurrentSquares("create",this.copySquareData(t)),u.debug("create section: ",s),d.dispatchEvent("change-square",{type:"create",trigger:"redo",id:h(t.id),pageNumber:t.pageNumber,props:t.props})}else t.operation==="modify"?(this.refreshTargetSquare(o.document.getElementById(t.id),t.props,"modify","redo"),this.updateCurrentSquares("modify",this.copySquareData(t))):t.operation==="delete"&&(this.refreshTargetSquare(t.id,t.props,"delete","redo"),this.deleteCurrentSquare(t.id),d.dispatchEvent("change-square",{type:"delete",trigger:"redo",id:h(t.id),pageNumber:t.pageNumber,props:t.props}));this.stackIndex++,this.refreshUndoRedoButton()}copySquareData(e){const t=d.deepCopy(e);return Object.hasOwn(t,"operation")&&delete t.operation,t}createSquareSection(e,t,n){if(o.document.getElementById(e)!=null){u.warn(`${e}の矩形は存在します`);return}if(t==null){u.debug("annotationLayer is null.","color: yellow");return}const s=o.document.createElement("section");return s.id=e,s.classList.add("square-annotation"),s.style.position="absolute",s.style.zIndex=z.squareZindex.nextIndex(),n!=null&&(s.style.left=`${n.x*100}%`,s.style.top=`${n.y*100}%`,s.style.right=null,s.style.bottom=null,s.style.width=`${n.width*100}%`,s.style.height=`${n.height*100}%`),k(s,I(e)),this.setSquareEvent(s),t.appendChild(s),s}setSquareEvent(e){this.mode==="edit"?(e.style.cursor=M.MOVABLE,e.style.pointerEvents=null,e.onmousedown=_.mouseDown(this,e.id),e.onclick=_.click()):(e.style.cursor=null,e.style.pointerEvents="none",e.onmousedown=null,e.onclick=null)}setAnnotationLayerPropagation(e){for(const t of e.children)Array.from(t.classList).some(s=>ie.includes(s))||(this.mode==="edit"?t.style.pointerEvents="none":t.style.pointerEvents="auto")}getAnnotations(){return xe(this.currentSquares)}setAnnotations(e){const t=ke(e);Ae(t,o.pagesCount),P().forEach(n=>n.remove()),this.clearUndoStack(),z.squareId.updateNextId(e.squares.map(n=>n.id)),this.initialSquares=t,this.currentSquares=d.deepCopy(t),this.editStateManager.setReadyState();for(let n=1;n<=o.pagesCount;n++)this.onRenderEvent(n);this.setSquareDoubleClick()}downloadData(){d.download(this.getAnnotations(),"annotations.json","application/json")}async importData(){const e=await d.selectFile(".json");this.setAnnotations(JSON.parse(e))}lockAnnotations(e){S.lockAnnotationIds=e.annotationIds.map(t=>C(t)).filter(t=>this.currentSquares.some(n=>n.id===t)),this.setAllSquaresStyle()}setAllSquaresStyle(){this.currentSquares.forEach(e=>{this.setSquareStyleWithState(e.id)})}setSquareStyleWithState(e){const t=I(e);t==="locked"?(this.editStateManager.isSelect(e)&&this.unselectSquare(e),k(e,"locked")):t==="normal"&&k(e,"normal"),this.editStateManager.isSelect(e)&&O(e)}setResizeHandlerStyle(){this.setResizeHandlerStyleWithPosition("top-left"),this.setResizeHandlerStyleWithPosition("top-right"),this.setResizeHandlerStyleWithPosition("bottom-left"),this.setResizeHandlerStyleWithPosition("bottom-right")}setResizeHandlerStyleWithPosition(e){const t=o.config.getConfig(),n=t.squareAnnotation.resizeHandlerStyle.backgroundColor,s=t.squareAnnotation.resizeHandlerStyle.borderRadius,a=t.squareAnnotation.resizeHandlerStyle.size,i=t.squareAnnotation.resizeHandlerStyle.position,c=this.getSquareHandlerId(e),l=o.document.getElementById(c);l.style.width=a,l.style.height=a,l.style.backgroundColor=n,l.style.borderRadius=s,e==="top-left"?(l.style.left=i,l.style.top=i):e==="bottom-left"?(l.style.left=i,l.style.bottom=i):e==="top-right"?(l.style.right=i,l.style.top=i):e==="bottom-right"&&(l.style.right=i,l.style.bottom=i)}selectSquare(e){const t=typeof e=="string"?o.document.getElementById(e):e,n=typeof e=="string"?e:t.id,s=this.editStateManager.selectSquareId;s!=null&&s!==n&&this.clearSelectStyle(s),O(t),this.drawResizeHandler(t),this.createDeleteIcon(t),this.editStateManager.setSelectState(n)}unselectSquare(e){e!=null&&(this.clearSelectStyle(e),this.removeResizeHandler(),this.removeDeleteIcon(),this.editStateManager.setReadyState())}deleteSquareElement(e){const{squareElement:t,squareId:n}=R(e);this.editStateManager.isSelect(n)&&(this.removeResizeHandler(),this.removeDeleteIcon()),t.remove()}clearSelectStyle(e){e!=null&&k(e,I(e))}removeResizeHandler(){const e=t=>{t?.remove()};e(o.document.getElementById(this.getSquareHandlerId("top-left"))),e(o.document.getElementById(this.getSquareHandlerId("top-right"))),e(o.document.getElementById(this.getSquareHandlerId("bottom-left"))),e(o.document.getElementById(this.getSquareHandlerId("bottom-right")))}removeDeleteIcon(){const e=o.document.getElementById("square-delete-icon");e?.remove()}allowCreateNew(){this.editStateManager.allowCreateNew=!0,o.pdfManager.getPages().forEach(e=>{const t=o.pdfManager.getAnnotationLayer(e);t!=null&&(t.style.cursor=M.CAN_CREATE)})}disallowCreateNew(){this.editStateManager.allowCreateNew=!1,o.pdfManager.getPages().forEach(e=>{const t=o.pdfManager.getAnnotationLayer(e);t!=null&&(t.style.cursor=null)})}scrollToSquare(e){const t=o.document.getElementById("viewerContainer");if(t==null)return;const n=C(e),s=this.currentSquares.find(c=>c.id===n);if(s==null)return;const a=o.pdfManager.getPage(s.pageNumber);if(a==null)return;const{y:i}=a.getBoundingClientRect();t.scroll(0,i+t.scrollTop),this._scrollToSquare(t,n,0)}_scrollToSquare(e,t,n){if(n>1e3)return;const s=o.document.getElementById(t);if(s==null)setTimeout(()=>{this._scrollToSquare(e,t,n+1)},1);else{const{y:a}=s.getBoundingClientRect();e.scrollTo({top:e.scrollTop+a-50,behavior:"smooth"})}}}class Oe{params=null;constructor(e){const n=(e??window.location.href).replace(window.location.origin+window.location.pathname,"");this.params=new URLSearchParams(n)}get(e,t=null){const n=this.params.get(e);return n??t}}class je{debug=!1;constructor(){const e=new Oe;this.debug=!!e.get("debug")}}o.params=new je;o.config=new ue;o.app=new K;window.openPdf=async r=>await o.app.open(r);window.setAppConfig=r=>{o.config.setConfig(r)};window.startEdit=()=>{o.squareAnnotation.setEditMode()};window.startPreview=()=>{o.squareAnnotation.setPreviewMode()};window.undo=()=>{o.squareAnnotation.undo()};window.redo=()=>{o.squareAnnotation.redo()};window.getAnnotations=()=>o.squareAnnotation.getAnnotations();window.setAnnotations=r=>{o.squareAnnotation.setAnnotations(r)};window.exportAnnotations=()=>{o.squareAnnotation.downloadData()};window.importAnnotations=async()=>{await o.squareAnnotation.importData()};window.lockAnnotations=r=>{o.squareAnnotation.lockAnnotations(r)};window.disallowCreateNew=()=>{o.squareAnnotation.disallowCreateNew()};window.allowCreateNew=()=>{o.squareAnnotation.allowCreateNew()};window.clearUndoStack=()=>{o.squareAnnotation.clearUndoStack()};window.scrollToSquare=r=>{o.squareAnnotation.scrollToSquare(r)};window.showCurrentSquares=()=>{o.squareAnnotation.showCurrentSquares()};window.onload=()=>{j(!1,!1)};window.addEventListener("webviewerloaded",async r=>{const e=r?.detail?.source,t=e.document,n=e.PDFViewerApplication,s=e.pdfjsLib;await n.initializedPromise;const a=await n.pdfLoadingTask.promise;o.app.successOpen(),n.eventBus.on("annotationeditorlayerrendered",async i=>{u.debug(`annotationeditorlayerrendered..... ${i.pageNumber}`,i),o.squareAnnotation.onRenderEvent(i.pageNumber,i.source)}),o.document=t,o.window=e,o.PDFViewerApplication=n,o.pdfjs=a,o.pdfjsLib=s,o.pagesCount=n.pagesCount,o.pdfManager=new fe,o.squareAnnotation=new q});
